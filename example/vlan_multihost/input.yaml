name: ospf_simple

global:
  path: local

module:
  - tinet
  - containerlab

file:
  - name: params.txt
  - name: network_config.txt
  - name: frr.conf
    path: /etc/frr/frr.conf
  - name: daemons
    path: /etc/frr/daemons
  - name: vtysh.conf
    path: /etc/frr/vtysh.conf

layer:
  - name: ip
    default_connect: true
    policy:
      - name: ip
        range: 10.0.0.0/16
        prefix: 24
      - name: lo
        type: loopback
        range: 10.0.255.0/24

param_rule:
  - name: vlan_id
    assign: segment
    layer: ip
    min: 100
    max: 1001
  - name: connection_id
    assign: connection
    header: conn
    min: 1
  - name: segment_id
    assign: segment
    layer: ip
    header: seg
    min: 1

nodeclass:
  - name: switch
    primary: true
    values:
      kind: linux
      image: nicolaka/netshoot
    config:
      - name: startup
        template:
          - "ip link add br0 type bridge"
          - "ip link set br0 up"
          - "{{ .interfaces_link }}"
  - name: router
    primary: true
    values:
      kind: linux
      image: quay.io/frrouting/frr:8.5.0
    interface_policy: [ip]
    params: [lo]
    config:
      - file: daemons
        sourcefile: ./daemons
      - file: vtysh.conf
        sourcefile: ./vtysh.conf
      - file: frr.conf
        blocks:
          after: ["interfaces_ospf_addr"]
        template:
          - "ip forwarding"
          - "!"
          - "router ospf"
          - " ospf router-id {{ .ip_loopback }}"
          - "{{ .interfaces_ospf_net }}"
          - "!"
      - name: startup
        template: []
      - file: params.txt
        style: sort
        sort_group: params.txt
      - file: network_config.txt
        style: sort
        sort_group: network_config.txt

interfaceclass:
  - name: all
    primary: true
    params: [connection_id]
    config:
      - name: link
        node: switch
        template:
          - "ip link set dev {{ .name }} promisc on"
          - "ip link set dev {{ .name }} master br0"
      - name: ospf_addr
        node: router
        template:
          - "interface {{ .name }}"
          - " ip address {{ .ip_addr }}/{{ .ip_plen }}"
          - "!"
      - name: ospf_net
        node: router
        template:
          - " network {{ .ip_net }} area 0"
      - group: network_config.txt
        template:
          - "interface {{ .node_name }}.{{ .name }} on connection {{ .conn_name }}"

connectionclass:
  - name: normal_conn
    primary: true
    prefix: "normal"
    params: [connection_id]
    config:
      - group: network_config.txt
        priority: -2
        template:
          - "# Normal Connection: {{ .name }} (ID: {{ .connection_id }})"
          - "connection {{ .name }} type normal"

  - name: vlan_conn
    prefix: "vlan_trunk"
    params: [connection_id, vlan_id]
    config:
      - group: network_config.txt
        priority: -2
        template:
          - "# VLAN Connection: {{ .name }} (ID: {{ .connection_id }}, VLAN: {{ .vlan_id }})"
          - "connection {{ .name }} type vlan_trunk vlan {{ .vlan_id }}"

segmentclass:
  - name: vlan_seg_A
    layer: ip
    config:
      - group: network_config.txt
        priority: -3
        template:
          - "# VLAN Segment A: VLAN {{ .vlan_id }} spanning {{ .segment_interface_count }} interfaces"
          - "vlan segment {{ .segment_name }} id {{ .vlan_id }} interfaces {{ .segment_interface_count }}"

  - name: vlan_seg_B
    layer: ip
    config:
      - group: network_config.txt
        priority: -3
        template:
          - "# VLAN Segment B: VLAN {{ .vlan_id }} spanning {{ .segment_interface_count }} interfaces"
          - "vlan segment {{ .segment_name }} id {{ .vlan_id }} interfaces {{ .segment_interface_count }}"

