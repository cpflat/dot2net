name: rip-topo1

module:
  - tinet
  - containerlab

file:
  - name: zebra.conf
    path: /etc/frr/zebra.conf
  - name: ripd.conf
    path: /etc/frr/ripd.conf
  - name: staticd.conf
    path: /etc/frr/staticd.conf
  - name: daemons
    path: /etc/frr/daemons
  - name: vtysh.conf
    path: /etc/frr/vtysh.conf
  - name: frr.log
    path: /var/log/frr.log

layer:
  - name: ip
    default_connect: true
    policy:
      - name: ip
        range: 10.0.0.0/16
        prefix: 24
      - name: lo
        type: loopback
        range: 10.0.255.0/24

nodeclass:
  - name: switch
    primary: true
    values:
      kind: linux
      image: nicolaka/netshoot
    config:
      - name: startup
        template:
          - "ip link add br0 type bridge"
          - "ip link set br0 up"
          - "{{ .interfaces_link }}"
  - name: router
    primary: true
    params: [lo]
    interface_policy: [ip]
    values:
      kind: linux
      image: nicolaka/netshoot
    config:
      - template:
          - chown frr:frr /var/log/frr.log 
      - file: daemons
        sourcefile: ./daemons
      - file: vtysh.conf
        sourcefile: ./vtysh.conf
      - file: frr.log
        sourcefile: ./frr.log
      - file: zebra.conf
        template:
          - "log file /var/log/frr.log"
          - "ip forwarding"
          - "ipv6 forwarding"
          - "!"
          - "{{ .interfaces_ifconf }}"
          - "line vty"
          - "!"
      - file: ripd.conf
        template:
          - "router rip"
          - " version 2"
          - " timers basic 5 180 5"
          - "{{ .interfaces_rip_network }}"
          - " redistribute connected"
          - " redistribute static"
          - "!"
          - "line vty"
          - "!"
      - file: staticd.conf
        template:
          - "{{ .interfaces_static_route }}"
  - name: vrouter
    virtual: true
    interface_policy: [ip]

interfaceclass:
  - name: all
    config:
      - name: link
        node: switch
        template:
          - "ip link set dev {{ .name }} promisc on"
          - "ip link set dev {{ .name }} master br0"
  - name: default
    config:
      - name: ifconf
        node: router
        template:
          - "interface {{ .name }}"
          - " ip address {{ .ip_addr }}/{{ .ip_plen }}"
          - "!"
  - name: rip
    config:
      - name: rip_network
        node: router
        template:
          - " network {{ .ip_net }}"
      - name: ifconf
        node: router
        template:
          - "interface {{ .name }}"
          - " description to {{ .opp_node_name }} - RIPv2 interface"
          - " ip address {{ .ip_addr }}/{{ .ip_plen }}"
          - " no link-detect"
          - "!"
  - name: to_stub
    config:
      - name: ifconf
        node: router
        template:
          - "interface {{ .name }}"
          - " description to {{ .opp_node_name }} - Stub interface"
          - " ip address {{ .ip_addr }}/{{ .ip_plen }}"
          - " no link-detect"
          - "!"
      - name: static_route
        node: router
        template:
          - "{{ .neighbors_ip_static_route_nb }}"
    neighbors:
      - layer: ip
        config:
          - name: static_route_nb
            node: router
            template:
              - "ip route {{ .n_node_stubnet }} {{ .n_ip_addr }}"
  - name: vlink
    virtual: true


